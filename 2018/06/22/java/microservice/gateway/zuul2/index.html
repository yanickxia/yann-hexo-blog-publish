<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/2020/logo-thin.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/2020/logo-thin.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/2020/logo-thin.png">
  <link rel="mask-icon" href="/images/2020/logo-thin.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.yanick.site","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.13.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp","menu_item":"fadeInDown"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Zuul2 Zuul2的难产，终于在 2018.4.13 上架了中心仓库，也代表着Zuul正式加入Netty全家桶的怀抱，关于 Zuul2 有一篇宏观性的博文有兴趣的可以阅读 Zuul 2 : The Netflix Journey to Asynchronous, Non-Blocking Systems 此篇博客。">
<meta property="og:type" content="article">
<meta property="og:title" content="Zuul2源码分析">
<meta property="og:url" content="http://blog.yanick.site/2018/06/22/java/microservice/gateway/zuul2/index.html">
<meta property="og:site_name" content="Yanick&#39;s Blog">
<meta property="og:description" content="Zuul2 Zuul2的难产，终于在 2018.4.13 上架了中心仓库，也代表着Zuul正式加入Netty全家桶的怀抱，关于 Zuul2 有一篇宏观性的博文有兴趣的可以阅读 Zuul 2 : The Netflix Journey to Asynchronous, Non-Blocking Systems 此篇博客。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s1.ax1x.com/2018/06/22/PSzIQs.png">
<meta property="og:image" content="https://s1.ax1x.com/2018/06/22/PSzHe0.png">
<meta property="og:image" content="https://s1.ax1x.com/2018/06/22/PpSZSH.png">
<meta property="article:published_time" content="2018-06-22T02:49:48.000Z">
<meta property="article:modified_time" content="2021-10-21T03:11:29.424Z">
<meta property="article:author" content="Yanick.xia">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2018/06/22/PSzIQs.png">


<link rel="canonical" href="http://blog.yanick.site/2018/06/22/java/microservice/gateway/zuul2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://blog.yanick.site/2018/06/22/java/microservice/gateway/zuul2/","path":"2018/06/22/java/microservice/gateway/zuul2/","title":"Zuul2源码分析"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zuul2源码分析 | Yanick's Blog</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Yanick's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Be Better & Have Fun</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-专栏"><a href="https://article.yanick.site/" rel="noopener" target="_blank"><i class="fa fa-edit fa-fw"></i>专栏</a></li><li class="menu-item menu-item-百科"><a href="https://wiki.yanick.site/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>百科</a></li><li class="menu-item menu-item-随想"><a href="https://misc.yanick.site/" rel="noopener" target="_blank"><i class="fas fa-compact-disc fa-fw"></i>随想</a></li><li class="menu-item menu-item-计划"><a href="/plan/" rel="section"><i class="fa fa-paper-plane fa-fw"></i>计划</a></li><li class="menu-item menu-item-推荐"><a href="/annual-recommend/2021.html" rel="section"><i class="fas fa-thumbs-up fa-fw"></i>推荐</a></li><li class="menu-item menu-item-地图"><a href="/knowledge-map/" rel="section"><i class="fa fa-map fa-fw"></i>地图</a></li><li class="menu-item menu-item-分享"><a href="/link/" rel="section"><i class="fa fa-link fa-fw"></i>分享</a></li><li class="menu-item menu-item-专题"><a href="/column/" rel="section"><i class="fa fa-columns fa-fw"></i>专题</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">Zuul2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Zuul2-%E6%9E%B6%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">Zuul2 架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ServerStartup"><span class="nav-number">1.2.</span> <span class="nav-text">ServerStartup</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E4%BC%91%E6%81%AF"><span class="nav-number">1.3.</span> <span class="nav-text">1&#x2F;3 休息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZuulServerChannelInitializer"><span class="nav-number">1.4.</span> <span class="nav-text">ZuulServerChannelInitializer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E4%BC%91%E6%81%AF"><span class="nav-number">1.5.</span> <span class="nav-text">2&#x2F;3 休息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZuulFilterChainHandler"><span class="nav-number">1.6.</span> <span class="nav-text">ZuulFilterChainHandler</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%88%E5%9C%BA%E4%BC%91%E6%81%AF"><span class="nav-number">1.7.</span> <span class="nav-text">终场休息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProxyEndpoint"><span class="nav-number">1.8.</span> <span class="nav-text">ProxyEndpoint</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.9.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E7%9F%A5%E8%AF%86"><span class="nav-number">1.10.</span> <span class="nav-text">参考知识</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Yanick.xia</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">145</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">117</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">95</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button site-overview-item animated">
    <button><i class="fa fa-comment"></i>
      Chat
    </button>
  </div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="mailto:me@yanick.site" title="Mail → mailto:me@yanick.site" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/yanickxia" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yanickxia" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/yann.xia" title="ZhiHu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yann.xia" rel="noopener" target="_blank"><i class="fab fa-zhihu fa-fw"></i>ZhiHu</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fas fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://sakeven.me/" title="https:&#x2F;&#x2F;sakeven.me&#x2F;" rel="noopener" target="_blank">Sakeven</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://reficul.io/" title="https:&#x2F;&#x2F;reficul.io&#x2F;" rel="noopener" target="_blank">Reficul</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.tomwei7.com/" title="https:&#x2F;&#x2F;www.tomwei7.com&#x2F;" rel="noopener" target="_blank">Tomwei</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.jinwei.me/" title="https:&#x2F;&#x2F;blog.jinwei.me" rel="noopener" target="_blank">Jinwei</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://renlulu.github.io/" title="https:&#x2F;&#x2F;renlulu.github.io&#x2F;" rel="noopener" target="_blank">Renlulu</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://justjjy.com/" title="http:&#x2F;&#x2F;justjjy.com&#x2F;" rel="noopener" target="_blank">JJY</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://zhyee.top/" title="http:&#x2F;&#x2F;zhyee.top" rel="noopener" target="_blank">Zhyee</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://blog.ihypo.net/" title="http:&#x2F;&#x2F;blog.ihypo.net" rel="noopener" target="_blank">Hypo</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://blog.heytaoge.com/" title="http:&#x2F;&#x2F;blog.heytaoge.com&#x2F;" rel="noopener" target="_blank">Taoge</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.hdls.me/" title="https:&#x2F;&#x2F;blog.hdls.me&#x2F;" rel="noopener" target="_blank">海的澜色</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://farer.org/" title="https:&#x2F;&#x2F;farer.org&#x2F;" rel="noopener" target="_blank">Windfarer</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.41tair.org/" title="https:&#x2F;&#x2F;blog.41tair.org&#x2F;" rel="noopener" target="_blank">Byron</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.yanick.site/2018/06/22/java/microservice/gateway/zuul2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yanick.xia">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanick's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Zuul2源码分析 | Yanick's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Zuul2源码分析
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-06-22 10:49:48" itemprop="dateCreated datePublished" datetime="2018-06-22T10:49:48+08:00">2018-06-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-10-21 11:11:29" itemprop="dateModified" datetime="2021-10-21T11:11:29+08:00">2021-10-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E7%BD%91%E5%85%B3/" itemprop="url" rel="index"><span itemprop="name">网关</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1>Zuul2</h1>
<p>Zuul2的难产，终于在 2018.4.13 上架了中心仓库，也代表着Zuul正式加入Netty全家桶的怀抱，关于 Zuul2 有一篇宏观性的博文有兴趣的可以阅读 <a target="_blank" rel="noopener" href="https://medium.com/netflix-techblog/zuul-2-the-netflix-journey-to-asynchronous-non-blocking-systems-45947377fb5c">Zuul 2 : The Netflix Journey to Asynchronous, Non-Blocking Systems</a> 此篇博客。</p>
<span id="more"></span>
<p>简而言之，Zuul2也就是从传统的 BIO 切换到了 NIO 模式。<br>
<img src="/images/loading.gif" data-original="https://s1.ax1x.com/2018/06/22/PSzIQs.png" alt="bio-thread"><br>
传统的BIO模型基于Thread的方式</p>
<p><img src="/images/loading.gif" data-original="https://s1.ax1x.com/2018/06/22/PSzHe0.png" alt="nio-thread"><br>
NIO模型基于Reactor模型</p>
<h2 id="Zuul2-架构"><a class="header-anchor" href="#Zuul2-架构">¶</a>Zuul2 架构</h2>
<p>从上帝视角来开，Zuul2是一个在 <code>Netty</code> 上运行一系列Filter的服务，执行完成PreFilter (inbound filters)之后将请求通过 <code>Netty Client</code> 转发出去，然后将请求的结果通过一系列PostFilter (outbound filters) 返回，如下图所示。<br>
<img src="/images/loading.gif" data-original="https://s1.ax1x.com/2018/06/22/PpSZSH.png" alt="Architectural-over"></p>
<p>正如之前的 <code>ZuulFilter</code> 分为了 <code>Pre</code>,<code>Post</code>,<code>Route</code>,<code>Error</code>，Zuul2的Filter分为三种类型</p>
<ul>
<li>Inbound Filters: 在路由之前执行</li>
<li>Endpoint Filters: 路由操作</li>
<li>Outbound Filters: 得到相应数据之后执行</li>
</ul>
<p>我们用官方的Demo进行分析 <a target="_blank" rel="noopener" href="https://github.com/Netflix/zuul/tree/2.1/zuul-sample">zuul-sample</a>，诸位看官自行下载导入。</p>
<h2 id="ServerStartup"><a class="header-anchor" href="#ServerStartup">¶</a>ServerStartup</h2>
<p>在Demo的启动中，我们发现启动的入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    ConfigurationManager.loadCascadedPropertiesFromResources(<span class="string">&quot;application&quot;</span>); ➊</span><br><span class="line">    <span class="type">Injector</span> <span class="variable">injector</span> <span class="operator">=</span> InjectorBuilder.fromModule(<span class="keyword">new</span> <span class="title class_">ZuulSampleModule</span>()).createInjector(); ➋</span><br><span class="line">    <span class="type">BaseServerStartup</span> <span class="variable">serverStartup</span> <span class="operator">=</span> injector.getInstance(BaseServerStartup.class);</span><br><span class="line">    server = serverStartup.server(); </span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">startupDuration</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">    System.out.println(<span class="string">&quot;Zuul Sample: finished startup. Duration = &quot;</span> + startupDuration + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line"></span><br><span class="line">    server.start(<span class="literal">true</span>); ➌</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 获得系统的一些配置参数<br>
➋ Demo中使用的是Google的Guice进行依赖注入的，这个就展开了有兴趣的可以自行去搜索<br>
➌ 启动一个Zuul2服务</p>
<p>我们从这个 <code>start()</code> 作为我们的突破口，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">boolean</span> sync)</span>&#123;</span><br><span class="line">    serverGroup = <span class="keyword">new</span> <span class="title class_">ServerGroup</span>(<span class="string">&quot;Salamander&quot;</span>, eventLoopConfig.acceptorCount(),   eventLoopConfig.eventLoopCount(), eventLoopGroupMetrics); ➊</span><br><span class="line">    serverGroup.initializeTransport();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        List&lt;ChannelFuture&gt; allBindFutures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// Setup each of the channel initializers on requested ports.</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, ChannelInitializer&gt; entry : portsToChannelInitializers.entrySet())</span><br><span class="line">        &#123;</span><br><span class="line">            allBindFutures.add(setupServerBootstrap(entry.getKey(), entry.getValue())); ➋</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Once all server bootstraps are successfully initialized, then bind to each port.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 构建一个新的 <code>ServerGroup</code><br>
➋ <code>setupServerBootstrap()</code> 初始化一个 <code>ServerBootstrap</code>，根据之前Netty的分析，我们知道Netty需要使用 <code>ServerBootstrap</code> 进行 端口绑定，那这里是不是就是那个东西。<br>
我们继续深入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ChannelFuture <span class="title function_">setupServerBootstrap</span><span class="params">(<span class="type">int</span> port, ChannelInitializer channelInitializer)</span></span><br><span class="line">            <span class="keyword">throws</span> InterruptedException&#123;</span><br><span class="line">    <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>().group(</span><br><span class="line">            serverGroup.clientToProxyBossPool,</span><br><span class="line">            serverGroup.clientToProxyWorkerPool); ➊</span><br><span class="line"></span><br><span class="line">    serverBootstrap.childHandler(channelInitializer); ➋</span><br><span class="line">    serverBootstrap.validate();</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">&quot;Binding to port: &quot;</span> + port);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Flag status as UP just before binding to the port.</span></span><br><span class="line">    serverStatusManager.localStatus(InstanceInfo.InstanceStatus.UP); ➌</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bind and start to accept incoming connections.</span></span><br><span class="line">    <span class="keyword">return</span> serverBootstrap.bind(port).sync();  ➍</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 ➊ 构建了一个 <code>ServerBootstrap</code> 这个正是Netty的启动类<br>
➋ 正如Netty的启动中的处理数据的 <code>Handler</code> 那这里应该也就是Zuul处理的核心所在<br>
➌ 一个我们的老朋友，和Eureka集成时改变服务器状态<br>
➍ 绑定 <code>ServerNioSockertChannel</code> 不再多做分析</p>
<h2 id="1-3-休息"><a class="header-anchor" href="#1-3-休息">¶</a>1/3 休息</h2>
<p>我们已经发现了Zuul2是如何启动一个Netty服务的，我们解决了图中红框部分的原理，那我们接下来去了解最为重要的这些Filter是如何工作的，我们上启动中已经发现一个很重要的对象 <code>channelInitializer</code> 我们知道在Netty中，是将一系列的 <code>Handler</code> 聚合在一起并使用 <code>Pipeline</code> 执行（参考<a target="_blank" rel="noopener" href="http://blog.yannxia.top/2018/06/20/java/netty/netty-3-pipeline/">Netty源码分析-(3)-ChannelPipeline</a>）我们可以猜测 zuul 的做法是类型，我们从这个 <code>channelInitializer</code> 入手去研究。</p>
<h2 id="ZuulServerChannelInitializer"><a class="header-anchor" href="#ZuulServerChannelInitializer">¶</a>ZuulServerChannelInitializer</h2>
<p>我们轻而易举的可以发现 <code>ChannelInitializer</code> 其实是  <code>ZuulServerChannelInitializer</code> 对象。在initChannel中我们发现了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">    storeChannel(ch);</span><br><span class="line">    addTimeoutHandlers(pipeline);</span><br><span class="line">    addPassportHandler(pipeline);</span><br><span class="line">    addTcpRelatedHandlers(pipeline);</span><br><span class="line">    addHttp1Handlers(pipeline);</span><br><span class="line">    addHttpRelatedHandlers(pipeline);</span><br><span class="line">    addZuulHandlers(pipeline); ➊</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在➊前面的都比较简单都是一些标准的 <code>Handler</code> 大家可以自己阅读，最为重要是 <code>addZuulHandlers(pipeline);</code> 这个函数，我们继续深入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addZuulHandlers</span><span class="params">(<span class="keyword">final</span> ChannelPipeline pipeline)</span>&#123;</span><br><span class="line">    pipeline.addLast(<span class="string">&quot;logger&quot;</span>, nettyLogger);</span><br><span class="line">    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ClientRequestReceiver</span>(sessionContextDecorator));</span><br><span class="line">    pipeline.addLast(passportLoggingHandler);</span><br><span class="line">    addZuulFilterChainHandler(pipeline); ➋</span><br><span class="line">    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ClientResponseWriter</span>(requestCompleteHandler, registry));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的都很容易看出来，是日志，Session之类的Handler，最为重要的是 ➋ 处增加 ZuulFilter。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addZuulFilterChainHandler</span><span class="params">(<span class="keyword">final</span> ChannelPipeline pipeline)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> ZuulFilter&lt;HttpResponseMessage, HttpResponseMessage&gt;[] responseFilters = getFilters(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">OutboundPassportStampingFilter</span>(FILTERS_OUTBOUND_START),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">OutboundPassportStampingFilter</span>(FILTERS_OUTBOUND_END)); ➊</span><br><span class="line"></span><br><span class="line">    <span class="comment">// response filter chain</span></span><br><span class="line">    <span class="keyword">final</span> ZuulFilterChainRunner&lt;HttpResponseMessage&gt; responseFilterChain = getFilterChainRunner(responseFilters,</span><br><span class="line">            filterUsageNotifier); ➋</span><br><span class="line"></span><br><span class="line">    <span class="comment">// endpoint | response filter chain</span></span><br><span class="line">    <span class="keyword">final</span> FilterRunner&lt;HttpRequestMessage, HttpResponseMessage&gt; endPoint = getEndpointRunner(responseFilterChain,</span><br><span class="line">            filterUsageNotifier, filterLoader); ➌</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ZuulFilter&lt;HttpRequestMessage, HttpRequestMessage&gt;[] requestFilters = getFilters(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InboundPassportStampingFilter</span>(FILTERS_INBOUND_START),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InboundPassportStampingFilter</span>(FILTERS_INBOUND_END));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// request filter chain | end point | response filter chain</span></span><br><span class="line">    <span class="keyword">final</span> ZuulFilterChainRunner&lt;HttpRequestMessage&gt; requestFilterChain = getFilterChainRunner(requestFilters,</span><br><span class="line">            filterUsageNotifier, endPoint);</span><br><span class="line"></span><br><span class="line">    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ZuulFilterChainHandler</span>(requestFilterChain, responseFilterChain));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从 ➊ 深入可以看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">ZuulMessage</span>&gt; ZuulFilter&lt;T, T&gt; [] getFilters(<span class="keyword">final</span> ZuulFilter start, <span class="keyword">final</span> ZuulFilter stop) &#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;ZuulFilter&gt; zuulFilters = filterLoader.getFiltersByType(start.filterType());</span><br><span class="line">    <span class="keyword">final</span> ZuulFilter[] filters = <span class="keyword">new</span> <span class="title class_">ZuulFilter</span>[zuulFilters.size() + <span class="number">2</span>];</span><br><span class="line">    filters[<span class="number">0</span>] = start;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>, j=<span class="number">0</span>; i &lt; filters.length &amp;&amp; j &lt; zuulFilters.size(); i++,j++) &#123;</span><br><span class="line">        filters[i] = zuulFilters.get(j);</span><br><span class="line">    &#125;</span><br><span class="line">    filters[filters.length -<span class="number">1</span>] = stop;</span><br><span class="line">    <span class="keyword">return</span> filters;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里返回了一个 <code>ZuulFilter</code> 的数组，开始分别是 <code>start</code> 和 <code>stop</code> 对应的刚好是 <code>OutboundPassportStampingFilter</code>。</p>
<p>然我们继续回到 <code>addZuulFilterChainHandler()</code> 函数上来，我们发现有三段相似的代码正好对应着获得了 <code>InBound</code><br>
<code>OutBond</code> <code>EndPoint</code> 这三种Filter，在代码我们可以看出顺序是</p>
<ol>
<li><code>requestFilters</code> 和 <code>endPointFilters</code> 合并成 <code>requestFilterChain</code></li>
<li><code>responseFilters</code> 构建成 <code>responseFilterChain</code></li>
<li><code>requestFilterChain</code> 和 <code>responseFilterChain</code> 组合成 <code>ZuulFilterChainHandler</code></li>
<li>将 <code>ZuulFilterChainHandler</code> 添加至 <code>pipeline</code> 中</li>
</ol>
<p>那这里我们还有一个疑问，这些Filter是从何而来的？这个答案隐藏在<br>
<code>com.netflix.zuul.FilterLoader#getFiltersByType</code> 中，通过简单的跟踪我们可以得到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Collection&lt;ZuulFilter&gt; <span class="title function_">getAllFilters</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.filters.values(); ➊</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里 ➊ 获得所有的Fiter，而这里的Filter看起来是通过 <code>Put</code>进来的，通过一个简单的断点，我们就可以发现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.netflix.zuul.FilterFileManager#init</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;    </span><br><span class="line">    filterLoader.putFiltersForClasses(config.getClassNames()); ➊</span><br><span class="line">    manageFiles();</span><br><span class="line">    startPoller();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 我们通过类的全称限定类名获得的这个Fitler，这个配置是在我们的配置文件中配置的。</p>
<h2 id="2-3-休息"><a class="header-anchor" href="#2-3-休息">¶</a>2/3 休息</h2>
<p>文至中场，我们已经明白了Zuul2如何将自己的 <code>ZuulFilter</code> 变换成 <code>Netty Handler</code> 并添加到 <code>Netty Pipeline</code> 之中的，那我们还剩下一个问题，这个 <code>ZuulFilter</code> 是如何运作的。但是我们在上段中，我们已经发现了最后是一个 <code>ZuulFilterChainHandler</code> 通过名称我们可以推测出，这是一个 <code>Chain 链</code>，我们继续往下探索吧。</p>
<h2 id="ZuulFilterChainHandler"><a class="header-anchor" href="#ZuulFilterChainHandler">¶</a>ZuulFilterChainHandler</h2>
<p>我们知道，最终注册到 <code>Netty Pipeline</code> 上的最终肯定是 <code>Handler</code>, 我们只需要从 Netty 的 <code>channelRead()</code> 函数作为突破口去阅读。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> HttpRequestMessage) &#123; ➊</span><br><span class="line">        zuulRequest = (HttpRequestMessage)msg;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Replace NETTY_SERVER_CHANNEL_HANDLER_CONTEXT in SessionContext</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">SessionContext</span> <span class="variable">zuulCtx</span> <span class="operator">=</span> zuulRequest.getContext();</span><br><span class="line">        zuulCtx.put(NETTY_SERVER_CHANNEL_HANDLER_CONTEXT, ctx);</span><br><span class="line">        zuulCtx.put(ZUUL_FILTER_CHAIN, requestFilterChain);</span><br><span class="line"></span><br><span class="line">        requestFilterChain.filter(zuulRequest); ➋</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((msg <span class="keyword">instanceof</span> HttpContent)&amp;&amp;(zuulRequest != <span class="literal">null</span>)) &#123;  ➌</span><br><span class="line">        requestFilterChain.filter(zuulRequest, (HttpContent) msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.debug(<span class="string">&quot;Received unrecognized message type. &quot;</span> + msg.getClass().getName());</span><br><span class="line">        ReferenceCountUtil.release(msg); ➍</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 这段逻辑处理 已经被转化为 <code>HttpRequestMessage</code> 类型的消息<br>
➋ 实际上的 filter 处理逻辑<br>
➌ 处理还没被转化为 <code>HttpRequestMessage</code> 类型的消息<br>
➍ 无法处理抛出异常，释放MSG</p>
<p>而这里的 <code>requestFilterChain</code> 就是之前我们传入进去的 <code>ZuulFilterChainRunner</code> 我们看看这 <code>filter()</code> 函数做了什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.netflix.zuul.netty.filter.ZuulFilterChainRunner#runFilters </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runFilters</span><span class="params">(<span class="keyword">final</span> T mesg, <span class="keyword">final</span> AtomicInteger runningFilterIdx)</span> &#123;</span><br><span class="line">    <span class="type">T</span> <span class="variable">inMesg</span> <span class="operator">=</span> mesg;</span><br><span class="line">    <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;-&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Preconditions.checkNotNull(mesg, <span class="string">&quot;Input message&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> runningFilterIdx.get(); ➊</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt; filters.length) &#123;</span><br><span class="line">            <span class="keyword">final</span> ZuulFilter&lt;T, T&gt; filter = filters[i]; ➋</span><br><span class="line">            filterName = filter.filterName();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">T</span> <span class="variable">outMesg</span> <span class="operator">=</span> filter(filter, inMesg); ➌</span><br><span class="line">            <span class="keyword">if</span> (outMesg == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">//either async filter or waiting for the message body to be buffered</span></span><br><span class="line">            &#125;</span><br><span class="line">            inMesg = outMesg;</span><br><span class="line">            i = runningFilterIdx.incrementAndGet(); ➍</span><br><span class="line">        &#125;</span><br><span class="line">        invokeNextStage(inMesg); ➎</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 获得当前运行的Filter的下标值<br>
➋ 获得对应的 <code>ZuulFilter</code><br>
➌ 调用 <code>ZuulFilter</code> 进行处理<br>
➍ 将下标志值 +1，继续循环体<br>
➎ 执行下个阶段，这里对应着我们自己再构建 <code>new InboundPassportStampingFilter(FILTERS_INBOUND_END)</code></p>
<p>通过这段代码，我们知道了 <code>Zuul2</code> 的Chain是由 <code>ChainRunner</code>运行，和Netty的Head tail的链方式大相径庭。<br>
在 <code>BaseZuulFilterRunner</code> 中的 <code>filter()</code> 函数也相当有趣。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.netflix.zuul.netty.filter.BaseZuulFilterRunner#filter </span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> O <span class="title function_">filter</span><span class="params">(<span class="keyword">final</span> ZuulFilter&lt;I, O&gt; filter, <span class="keyword">final</span> I inMesg)</span> &#123;</span><br><span class="line">  filter.incrementConcurrency();</span><br><span class="line">    resumer = <span class="keyword">new</span> <span class="title class_">FilterChainResumer</span>(inMesg, filter, snapshot, startTime); ➊</span><br><span class="line">    filter.applyAsync(inMesg) ➋</span><br><span class="line">        .observeOn(Schedulers.from(getChannelHandlerContext(inMesg).executor()))  ➌</span><br><span class="line">        .doOnUnsubscribe(resumer::decrementConcurrency)</span><br><span class="line">        .subscribe(resumer);  ➍</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;  <span class="comment">//wait for the async filter to finish</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 临时存储起来这个Filter待异步完成回调<br>
➋ 具体的执行处<br>
➌ 获取当前的所在的 <code>EventExecutor</code> 并在这个线程上观察<br>
➍ 将数据在 resumer 中消费</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(O outMesg)</span> &#123;  ➊</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        recordFilterCompletion(SUCCESS, filter, startTime, inMesg, snapshot);</span><br><span class="line">        <span class="keyword">if</span> (outMesg == <span class="literal">null</span>) &#123;</span><br><span class="line">            outMesg = filter.getDefaultOutput(inMesg);</span><br><span class="line">        &#125;</span><br><span class="line">        resumeInBindingContext(outMesg, filter.filterName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 处获得我们的结果并将其恢复到我们保管的 <code>filter</code>。</p>
<p>剩余关于 <code>ReponseFilter</code> 的运行机制是类似的，诸位看官自行分析下。</p>
<h2 id="终场休息"><a class="header-anchor" href="#终场休息">¶</a>终场休息</h2>
<p>通过上面的一系列分析，我们已经知道的，Zuul的 <code>调用链模型</code>，<code>PreFilters</code>的运行机制，整个Zuul2的运行机制在我们的面前一览无遗。整体的Zuul代码是相当的明了的，代码的分层也很好，但是还有一朵乌云在我们的头顶之上，那就是在那张途中的 <code>Netty Client</code> 我们并没有发现其踪迹，但是我们知道只有在 <code>End</code> 阶段，我们才会对外进行访问，在官网的Wiki中，我们也可以获得</p>
<blockquote>
<p>Zuul does not use Ribbon for making outgoing connections and instead uses its own connection pool, using a Netty client. Zuul creates a connection pool per host, per event loop. It does this in order to reduce context switching between threads and to ensure sanity for both the inbound event loops and outbound event loops. The result is that the entire request is run on the same thread, regardless of which event loop is running it.</p>
</blockquote>
<p>我们从 <code>Wiki</code> 中可以得知，Netty不再默认使用 Ribbon 而是默认使用 <code>Netty</code> 作为一个 <code>Client</code>.</p>
<h2 id="ProxyEndpoint"><a class="header-anchor" href="#ProxyEndpoint">¶</a>ProxyEndpoint</h2>
<p>这个类的对象及其的复杂，我们从filter的核心逻辑 <code>apply</code>看起来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> HttpResponseMessage <span class="title function_">apply</span><span class="params">(<span class="keyword">final</span> HttpRequestMessage input)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        origin.getProxyTiming(zuulRequest).start();</span><br><span class="line">        origin.onRequestExecutionStart(zuulRequest, <span class="number">1</span>);</span><br><span class="line">        proxyRequestToOrigin(); ➊</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 将请求转发至远端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">proxyRequestToOrigin</span><span class="params">()</span> &#123;</span><br><span class="line">    Promise&lt;PooledConnection&gt; promise = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        promise = origin.connectToOrigin(zuulRequest, channelCtx.channel().eventLoop(), attemptNum, passport, chosenServer); ➊</span><br><span class="line"></span><br><span class="line">        currentRequestAttempt = origin.newRequestAttempt(chosenServer.get(), context, attemptNum); </span><br><span class="line">        <span class="keyword">if</span> (promise.isDone()) &#123;</span><br><span class="line">            operationComplete(promise); ➋</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            promise.addListener(<span class="built_in">this</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 处将请求包装，连接到远端地址，获得 Promise<br>
➋ 结束的 Promise 处理，在 <code>operationComplete()</code> 中包含了成功的执行代码，至于 <code>connectToOrigin</code> Zuul 包装了 Netty的Client。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeClientRequestToOrigin</span><span class="params">(<span class="keyword">final</span> PooledConnection conn)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">ch</span> <span class="operator">=</span> conn.getChannel(); ➊</span><br><span class="line"></span><br><span class="line">    ch.write(zuulRequest);   ➋</span><br><span class="line">    writeBufferedBodyContent(zuulRequest, ch);</span><br><span class="line">    ch.flush(); ➌</span><br><span class="line">    <span class="comment">//Get ready to read origin&#x27;s response</span></span><br><span class="line">    ch.read(); ➍</span><br><span class="line"></span><br><span class="line">    originConn = conn;</span><br><span class="line">    channelCtx.read(); ➎</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 获得建立的连接<br>
➋ 写入Zuul的请求，也就是用户的请求<br>
➌ 将消息Flush出去<br>
➍ 在这里读取响应的数据，也就是触发 <code>OutBoundHandler</code> 的处理时间</p>
<h2 id="总结"><a class="header-anchor" href="#总结">¶</a>总结</h2>
<p>Zuul整体逻辑，我们通过博文可以分析而出。</p>
<ol>
<li>ZuulFilter 分为 <code>Inbound</code>, <code>Outbound</code>, <code>EndPoint</code></li>
<li><code>Inbound</code>, <code>Outbound</code>, <code>EndPoint</code> 包裹成 <code>ChainRunner</code></li>
<li><code>ChainRunner</code> 组合成一个 <code>ZuulFilterChainHandler</code>，而 <code>ZuulFilterChainHandler</code> 是Netty的 一个Handler</li>
<li><code>ZuulFilterChainHandler</code> 会组装到 Netty 的 <code>Pipeline</code> 中，剩下来就是Netty的流程了</li>
</ol>
<h2 id="参考知识"><a class="header-anchor" href="#参考知识">¶</a>参考知识</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://gank.io/post/560e15be2dca930e00da1083">给 Android 开发者的 RxJava 详解</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000004856071">谜之RxJava （三）update 2 —— subscribeOn 和 observeOn 的区别</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Netflix/zuul/wiki">Zuul-Wiki</a></li>
</ul>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
    </div>

    
    
    
      


    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/06/21/java/netty/netty-5-otherwise/" rel="prev" title="Netty源码分析-(5)-其他">
                  <i class="fa fa-chevron-left"></i> Netty源码分析-(5)-其他
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2018/06/26/java/spring/projectreactor/" rel="next" title="由表及里学 ProjectReactor">
                  由表及里学 ProjectReactor <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">苏ICP备15036539号-2 </a>
  </div>

<div class="copyright">
  &copy; 2015 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yanick.Xia</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><p>本网站由<a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img src="/images/loading.gif" data-original="images/upyun_logos/logo2.png" style="display: inline; height: 15px;"></a>提供CDN加速/云存储服务</p>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script class="next-config" data-name="chatra" type="application/json">{"enable":true,"async":true,"id":"ZPdnXR7os9z2MNTzG"}</script>
<script src="/js/third-party/chat/chatra.js"></script>
<script async src="https://call.chatra.io/chatra.js"></script>





  






        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(e){e.imageLazyLoadSetting.processImages=t;var n=e.imageLazyLoadSetting.isSPA,i=e.imageLazyLoadSetting.preloadRatio||1,r=o();function o(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){n&&(r=o());for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(e.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];e=function(){r=r.filter(function(t){return o!==t})},(t=o).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,t.removeAttribute("data-original"),e&&e()},t.src!==i&&(n.src=i))}()}function a(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",a),e.addEventListener("resize",a),e.addEventListener("orientationchange",a)}(this);</script></body>
</html>
